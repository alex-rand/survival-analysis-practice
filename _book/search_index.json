[["prison-addicts.html", "Prison Addicts 1.1 Basic Exploration 1.2 How does time-to-event vary with prison status? 1.3 How does time-to-event vary with dosage?", " Prison Addicts 1.1 Basic Exploration I can’t seem to find any documentation explaining the experiment this data corresponds to. So let’s see if we can figure out the gist of it. Table 1.1: skim_type skim_variable n_missing numeric.hist numeric id 0 ▇▇▆▇▇ numeric clinic 0 ▇▁▁▁▃ numeric status 0 ▅▁▁▁▇ numeric days_survival 0 ▇▅▆▃▁ numeric prison 0 ▇▁▁▁▇ numeric dose 0 ▁▇▇▃▁ So it looks like we’ve got the following: ID is just your basic identifier; Clinic is a cluster variable. But there’s only two clusters, so not really enough to do a frailty model since that would only be two data points with which to estimate the sigma between clusters. Could be interesting to try out a stratified Cox though, or at least do those tests Singer and Willett mention to explore whether the clusters have different baselines; Status is the event column; Prison is ambiguous without documentation: are these people who are currently in prison, or people who have been in prison in the past? Either way, it will be a predictor to explore; Dose is I guess the treatment. It is continuous, which will be fun. I’m curious to explore the values within the Dose column a bit more: So dosage amounts are pretty varied, with 15 distinct levels. Ok. So now we can do some basic exploratory stuff with the event times for the whole sample. Singer and Willett recommend starting with the Kaplan Meier, Cumulative Hazard, and Kernel-Smoothed Hazard, so that’s what we’ll do. We’ll use the canonical survival package, as well as the helpful survminer package for visualizations. The workflow starts with a weird first step: we need to create a ‘survival object’ of the type that the functions of the survival package can understand. This just takes the time_to_event and status columns of your dataset and turns them into a single column, where a number alone is a time-to-event, and a number with a plus sign beside it is time-to-censored. This is just the way they’ve decided to do things. Then we can use this ‘survival object’ to get the various curves we need. So here we go: # Create survival object surv_object &lt;- Surv(dat$days_survival, dat$status) # Fit the Kaplan-Meier curve km.full.sample &lt;- survfit(surv_object ~ 1, data = dat) # Plot the Kaplan-Meier curve km_full_sample_plot &lt;- survminer::ggsurvplot( fit = km.full.sample, conf.int = TRUE, risk.table = TRUE, surv.median.line = &quot;v&quot;, linetype = 1, legend = &quot;none&quot;, palette = c(&quot;cadetblue4&quot;), title = &quot;Kaplan-Meier Estimated Survival Curve&quot;, xlab = &quot;&quot;, ylab = &quot;&quot;, ggtheme = theme_bw() ) # Plot the Negative-Log cumulative hazard cumhaz_full_sample_plot &lt;- survminer::ggsurvplot( fit = km.full.sample, conf.int = TRUE, linetype = 1, legend = &quot;none&quot;, palette = c(&quot;burlywood4&quot;), title = &quot;Negative Log Cumulative Hazard&quot;, xlab = &quot;&quot;, ylab = &quot;&quot;, ggtheme = theme_bw(), fun = &quot;cumhaz&quot; ) # Plot the kernel-smoothed hazard kernel_smoothed_full_sample &lt;- kernel_smoothed_hazard(width=60, time=dat$days_survival * 2, survive=dat$status + 1) %&gt;% ggplot(aes(x = x, y = y)) + geom_line(colour = &quot;aquamarine4&quot;, size = 2, alpha = .8) + geom_line(colour = &quot;white&quot;, size = .2) + ggtitle(&quot;Kernel-Smoothed Approximation of Hazard Function&quot;) + xlab(&quot;Days After Completing amplify&quot;) + ylab(&quot;Smoothed Hazard&quot;) + theme_bw() Things are looking pretty consistent here. You have the typical thing of hazard being low at first but then increasing at psychologically-salient anniversaries, IE the two-month mark and the one-year mark. Things also seem to really take off at the 500 day mark as well. Based on the data available, there are a few things I’m curious about: How does time-to-event vary with prison status? How does time-to-event vary with dosage amount? Does the effect of dosage amount on time-to-event vary in prison status? In other words, is there an interaction between dosage and prison status? Is the proportional hazards assumption justified given the possibility of different baseline hazards across clinics? Let’s explore each of these questions. 1.2 How does time-to-event vary with prison status? For starters, we can plot the cumulative hazard curves for the two groups in isolation. If the cumulative hazard curves aren’t generally parallel on the log scale then when it comes time to model we should probably think about doing one of the things Singer and Willett suggest we do when we seem to have different baselines, between strata, IE either: Do a stratified Cox regression; Do time-varying effects. So let’s plot the stratified log cumulative hazard curves. To do this, we can start by getting the Kaplan-Meier estimates for the different strata. Then the resulting Kaplan-Meier fit object will contain everything we need to calculate log cumulative hazard and make a nice custom plot: # Fit the new stratified Kaplan-Meier curve km.prison.strata &lt;- survfit(surv_object ~ 1 + strata(prison), data = dat) # Use the new stratified Kaplan-Meier estimates to create a new table with the columns we need, namely: # 1. Prison status; # 2. Time-to-event for each person; # 3. Log cumulative hazard at each event time; # 4. Confidence intervals to sexy-up the plot. tibble( prison = as.factor(rep(c(0, 1), times = c(112, 99))), time = km.prison.strata$time, log_cumhaz = log(km.prison.strata$cumhaz), conf_lower = log(-log(km.prison.strata$lower)), conf_upper = log(-log(km.prison.strata$upper)) ) %&gt;% # Plot ggplot(aes(x = time, y = log_cumhaz, colour = prison, group = prison, fill = prison)) + geom_point(shape = 3, size = 2) + geom_line(size = 1) + geom_ribbon(aes(ymin = conf_lower, ymax = conf_upper), alpha=0.3, linetype = 0) + scale_colour_manual(values = c(&quot;cadetblue4&quot;,&quot;burlywood4&quot;)) + scale_fill_manual(values = c(&quot;cadetblue4&quot;,&quot;burlywood4&quot;)) + theme_bw() + theme( plot.title = element_text(face = &quot;bold&quot;, size = 12), legend.background = element_rect(fill = &quot;white&quot;, size = 4, colour = &quot;white&quot;), legend.justification = c(0, 1), legend.position = &quot;bottom&quot;, axis.ticks = element_line(colour = &quot;grey70&quot;, size = 0.2), panel.grid.major = element_line(colour = &quot;grey70&quot;, size = 0.2), panel.grid.minor = element_blank() ) Based on this plot it looks like the log cumulative hazards are sort of proportional-ish. Things get a bit weird between days 70 and 150, and again after 600 days, but generally the prison group is above the non-prison group by a more-or-less consistent amount. I don’t feel super comfortable making a call about the validity of the proportional hazards assumption based on this plot alone. Another way of investigating the validity of the proportional hazards assumption for a particular predictor (and take the decision out of pure judgement-call territory) is to look at the Schoenfeld residuals of a cox regression with only prison as a predictor. Then we can look at the p-value of the Schoenfeld residuals and use that as a cutoff in the typical significance-testing way. # Fit a Cox regression cox.prison.only &lt;- coxph(surv_object ~ 1 + prison, data = dat) # Get a zph object, which takes a Cox model object and returnslots of nice diagnostic information specifically about the proportional hazards assumption of that Cox model zph_object_cox_prison &lt;- cox.zph(cox.prison.only) # Plot the Schoenfeld residuals with Survminer survminer::ggcoxzph(zph_object_cox_prison, point.col = &quot;cadetblue4&quot;) This all suggests that the effect of being in prison might vary over time a bit, but the Schoenfeld p-value isn’t below .05, so I guess we are justified in not worrying about that. Our conclusion is that we can feel good about adopting the proportional hazards assumption for the prison variable. If instead we had found that prison varies a bunch over time then we could do a stratified regression by prison. But Singer and Willett point out that if we do this then we won’t get a parameter estimate for the influence of prison, and that’s a parameter estimate it would be nice to have. So instead we can relax the proportional hazards assumption by interacting prison with time. We’re not gonna do this now because our Schoenfeld residuals say we don’t have to but the authors of the Survival package have written some nice documentation about precisely how to do this. Next let’s look at the real heart of the analysis: the treatment effect. 1.3 How does time-to-event vary with dosage? The treatment here is a continuous variable, making it tricky to visually assess the proportional hazards assumption with stratified log cumulative hazard curves. We still could do it via Singer and Willett’s general approach to visualization with continuous variables, IE choosing a few exemplary values of the continuous variables to plot, or as they call it, “judicious categorization”. So barring any background knowledge on which to base this assumption (I don’t even know what this experiment actually is), we’ll need to depend on our old friend the Schoenfeld residuals to assess the proportional hazards assumption: # Fit a Cox regression cox.dose.only &lt;- coxph(surv_object ~ 1 + dose, data = dat) # Get a zph object, which takes a Cox model object and returnslots of nice diagnostic information specifically about the proportional hazards assumption of that Cox model zph_object_cox_dose &lt;- cox.zph(cox.dose.only) # Plot the Schoenfeld residuals with Survminer survminer::ggcoxzph(zph_object_cox_dose, point.col = &quot;cadetblue4&quot;) Looks plenty flat to me, and a p-value far from .05. So we’re safe to assume that the proportional hazards model holds for the Dose variable. So let’s go ahead and fit a basic Cox model with Dose as the only predictor to get an estimate of the hazard ratio. Actually, we’ve already fit the model to get the Schoenfeld residuals above. So let’s have a look at the regression outputs. # Fit a Cox regression broom::tidy(cox.dose.only, exponentiate = TRUE) %&gt;% mutate(p.value = as.character(p.value)) %&gt;% janitor::clean_names(&quot;title&quot;) %&gt;% knitr::kable(caption = &quot;&quot;) %&gt;% kableExtra::kable_styling(bootstrap_options = &quot;striped&quot;) Table 1.2: Term Estimate Std Error Statistic P Value dose 0.9647342 0.0059768 -6.006972 1.89020241735986e-09 Based on the estimated hazard ratio, the model thinks that each additional unit of dosage reduces hazard by about 3.5% in relative terms. So the model expects that if a person with a dosage of 0 has 50% hazard, then a person with a dosage of 1 will have a hazard of about (.50 * .965) ~ 48%, a person with a dosage of 10 will have a hazard of about (.50 * .96510) ~ 35%, and a person with a dosage of 100 will have a hazard of about (.50 * .965100) ~ 1.4%. This is what the model thinks. Also wow, that is a very tiny p-value, which suggests that given the size and variance of the sample, the model’s estimate of the treatment effect does not seem compatible with a true effect of 0, b In other words, if we assume that our sample of people is a perfect representation of some infinitely large group of people, then the model things that if we did this same experiment over and over and over infinitely many times, each time drawing a different random group of people from that infinite group of people of the same size as the experiment we actually did, then we would only see the effect we saw (or a bigger one) like 2 of every billion experiments. This is a pretty weird thing to say, but this is how p-values work. So the model thinks the effect is of the treatment is big, with higher dosage reducing hazard. Another nice way of visualizing the treatment effect is to choose some theoretically interesting values of dosage and generate the model’s survival curves for them. The way to do this is to… EXPLAIN # Create fake data with the desired values of dosage bind_rows( survminer::surv_adjustedcurves(cox.dose.only, data = tibble(dose = 0)) %&gt;% mutate(dosage = &quot;Dose = 0&quot;), survminer::surv_adjustedcurves(cox.dose.only, data = tibble(dose = 20)) %&gt;% mutate(dosage = &quot;Dose = 20&quot;), survminer::surv_adjustedcurves(cox.dose.only, data = tibble(dose = 40)) %&gt;% mutate(dosage = &quot;Dose = 40&quot;), survminer::surv_adjustedcurves(cox.dose.only, data = tibble(dose = 60)) %&gt;% mutate(dosage = &quot;Dose = 60&quot;), survminer::surv_adjustedcurves(cox.dose.only, data = tibble(dose = 80)) %&gt;% mutate(dosage = &quot;Dose = 80&quot;) ) %&gt;% # Plot ggplot(aes(x = time, y = surv, group = dosage, colour = dosage)) + geom_point(shape = 3, size = 2) + geom_line(size = 1) + scale_colour_manual(values=c(&quot;burlywood4&quot;, &quot;deepskyblue4&quot;, &quot;aquamarine4&quot;, &quot;cadetblue4&quot;, &quot;antiquewhite4&quot;)) + theme_bw() + theme( plot.title = element_text(face = &quot;bold&quot;, size = 12), legend.background = element_rect(fill = &quot;white&quot;, size = 4, colour = &quot;white&quot;), legend.justification = c(0, 1), legend.position = &quot;bottom&quot;, axis.ticks = element_line(colour = &quot;grey70&quot;, size = 0.2), panel.grid.major = element_line(colour = &quot;grey70&quot;, size = 0.2), panel.grid.minor = element_blank(), legend.title = element_blank() ) Could be nice to do some martingale residuals of prison status against the dosage only model, to see if prison status is worth including despite not being a juicy p-value. https://github.com/alex-rand/survival-analysis-practice.git "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
